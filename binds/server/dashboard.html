<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        :root {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>

<body>
    <h1>Dashboard</h1>
    <main id="root"></main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer>
        const rootEl = document.getElementById("root");
        if (!rootEl) {
            throw new Error("Root element not found");
        }

        const charts = new Array();

        function utcTimeFormat(x) {
            if (typeof x == "number") {
                return (new Date(x * 1000)).toLocaleTimeString();
            } else if ("time" in x) {
                return utcTimeFormat(x.time);
            } else {
                console.error("Could now format time", x);
                return "";
            }
        }

        function addChart(sensor) {
            const data = {
                labels: sensor.data.map(utcTimeFormat),
                datasets: [
                    {
                        label: `${sensor.name} in ${sensor.unit}`,
                        data: sensor.data.map(x => x.value),
                        borderColor: "rgb(153, 102, 255)",
                        backgroundColor: "rgba(153, 102, 255, 0.5)",
                    }
                ]
            };

            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: sensor.name,
                        }
                    }
                },
            };

            const canvasEl = document.createElement("canvas");
            rootEl.appendChild(canvasEl);
            charts.push({
                name: sensor.name,
                canvas: canvasEl,
                chart: new Chart(
                    canvasEl,
                    config,
                ),
            });
        }

        async function initCharts() {
            const sensorsRes = await fetch("/sensor");
            if (!sensorsRes.ok) {
                console.error("failed to fetch sensors");
                return;
            }
            const { sensors } = await sensorsRes.json();
            if (!Array.isArray(sensors)) {
                console.error("Type error. Sensors is not Array", sensors);
                return;
            }
            for (const sensor of sensors) {
                addChart(sensor)
            }
        }

        async function updateCharts() {
            for (const chart of charts) {
                const sensorRes = await fetch("/sensor/" + chart.name);
                if (!sensorRes.ok) {
                    console.error(`Failed to update sensor "${chart.name}"`)
                    continue;
                }
                const sensor = await sensorRes.json()
                chart.chart.data.labels = sensor.data.map(utcTimeFormat);
                chart.chart.data.datasets[0].data = sensor.data.map(x => x.value);
                chart.chart.update();
                console.debug(`Updated sensor ${chart.name}`);
            }
        }

        initCharts();

        window.setInterval(updateCharts, 5000);
    </script>
</body>

</html>